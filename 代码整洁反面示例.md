# é‡å¤ä»£ç ï¼ˆduplicated codeï¼‰
é‡å¤ä»£ç ä¸€èˆ¬æ˜¯å› ä¸ºéœ€æ±‚è¿­ä»£æ¯”è¾ƒå¿«ï¼Œå¼€å‘å°ä¼™ä¼´æ‹…å¿ƒå½±å“å·²æœ‰åŠŸèƒ½ï¼Œå°±å¤åˆ¶ç²˜è´´é€ æˆçš„ã€‚é‡å¤ä»£ç å¾ˆéš¾ç»´æŠ¤çš„ï¼Œå¦‚æœä½ è¦ä¿®æ”¹å…¶ä¸­ä¸€æ®µçš„ä»£ç é€»è¾‘ï¼Œå°±éœ€è¦ä¿®æ”¹å¤šæ¬¡ï¼Œå¾ˆå¯èƒ½å‡ºç°é—æ¼çš„æƒ…å†µï¼Œéšç€é¡¹ç›®ä¸­é‡å¤ä»£ç è¶Šæ¥è¶Šå¤šï¼Œé¡¹ç›®å˜å¾—è¶Šéš¾ç»´æŠ¤ã€‚

# é•¿å‡½æ•°ï¼Œé•¿æ–¹æ³•ï¼ˆlong methodï¼‰
é•¿å‡½æ•°æ˜¯æŒ‡ä¸€ä¸ªå‡½æ•°æ–¹æ³•å‡ ç™¾è¡Œç”šè‡³ä¸Šåƒè¡Œï¼Œå¯è¯»æ€§å¤§å¤§é™ä½ï¼Œä¸ä¾¿äºç†è§£ï¼Œ æœ‰æ—¶MRåˆå¹¶è¯·æ±‚æµæ°´çº¿é—¨ç¦ä¼šè®¾ç½®ç¦æ­¢è¶…å¤šä¸€å®šè¡Œæ•°çš„å‡½æ•°æˆ–æ–¹æ³•è¿‡é—¨ç¦ï¼Œä½¿ç”¨extract methodå·¥å…·ï¼Œä¼˜åŒ–è¶…å¤§è¡Œçš„æ–¹æ³•ï¼ŒæŠ½å–åŠŸèƒ½å•ä¸€çš„ä»£ç ç‰‡æ®µï¼Œç»„æˆå‘½åæ¸…æ™°çš„çŸ­å‡½æ•°ã€‚

# è¿‡å¤§çš„ç±»ï¼ˆlarge classï¼‰
ä¸€ä¸ªç±»ä¸“æ³¨åšä¸€ä»¶äº‹ï¼Œç±»ä¸­çš„å±æ€§å’Œæ–¹æ³•ä¸ºè¿™ä¸€ä»¶äº‹æœåŠ¡ï¼Œä¸è¦åœ¨ä¸€ä¸ªç±»ä¸­æ”¾å…¥å¤ªå¤šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚è®¢å•ç±»ä¸­æ”¾å…¥åº“å­˜å’Œç§¯åˆ†è¿˜æœ‰æ”¯ä»˜ç›¸å…³çš„åŠŸèƒ½ï¼Œè¿™æ ·å¯è¯»æ€§å˜å·®ï¼Œè€Œä¸”è¿åäº†å•ä¸€èŒè´£åŸåˆ™

# è¿‡é•¿å‚æ•°åˆ—ï¼ˆlong parameterï¼‰
å‡½æ•°æˆ–æ–¹æ³•å‚æ•°è¿‡å¤šï¼Œå¯è¯»æ€§å˜å·®ï¼Œä¸”è°ƒç”¨ä¹Ÿå®¹æ˜“å‡ºé”™ï¼Œåšæ–°è€æ¥å£å…¼å®¹ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚ å°†ä¸€ç»„ç›¸å…³å‚æ•°å°è£…æˆç»“æ„ä½“æˆ–è€…ç±»ï¼Œå¦‚å°†ä¸€ç»„é•¿å‚æ•°å°è£…æˆä¸€ä¸ªDTOç±»

# ä¾æ‹æƒ…ç»“ï¼ˆfeature envyï¼‰
æŸä¸ªæ–¹æ³•æˆ–è€…å‡½æ•°ä¸ºäº†è®¡ç®—æŸä¸ªå€¼ï¼Œä»å¦ä¸€ä¸ªç±»æˆ–è€…å¯¹è±¡ä¸­è°ƒç”¨äº†å¾ˆå¤šå±äºè¯¥å¯¹è±¡çš„å–å€¼å‡½æ•°ï¼ˆä¸€ä¸ªå‡½æ•°ä½¿ç”¨äº†å¤§é‡å…¶ä»–ç±»çš„æˆå‘˜ï¼‰ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œå¯è€ƒè™‘æœ‰æ²¡å¿…è¦å°†è¯¥å‡½æ•°æˆ–æ–¹æ³•ç§»åŠ¨åˆ°å®ƒä½¿ç”¨çš„ç±»ä¸­ã€‚

# Switchè¯­å¥ã€if è¯­å¥
å¦‚æœä»£ç ä¸­åŒ…å«å¾ˆå¤šåˆ†æ”¯åˆ¤æ–­ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè€ƒè™‘æœ‰æ²¡å¿…è¦ä½¿ç”¨å¤šæ€ä¼˜åŒ–

# è¿‡å¤šçš„æ³¨é‡Š
é¿å…ç”¨æ³¨é‡Šè§£é‡Šä»£ç ï¼Œé¿å…è¿‡å¤šçš„æ³¨é‡Šã€‚ æ–¹æ³•å‡½æ•°ã€å˜é‡å‘½åè¦è§„èŒƒã€æµ…æ˜¾æ˜“æ‡‚ï¼Œé¿å…ç”¨æ³¨é‡Šè§£é‡Šä»£ç ã€‚å…³é”®ã€å¤æ‚çš„ä¸šåŠ¡ï¼Œä½¿ç”¨æ¸…æ™°ã€ç®€æ˜çš„æ³¨é‡Šã€‚
+ å¤šä½™æ³¨é‡Š
+ æ—¥å¿—å¼æ³¨é‡Š
+ ç”¨æ³¨é‡Šè§£é‡Šå˜é‡

```java
private Integer inputToken;  // è¾“å…¥tokené•¿åº¦
private Integer outputToken; // è¾“å‡ºtokené•¿åº¦
```
ä¸Šé¢è¿™æ®µä»£ç æ³¨é‡Šå°±æ˜¯ç”¨æ³¨é‡Šè§£é‡Šä»£ç çš„å…¸å‹åé¢ç¤ºä¾‹ã€è€Œä¸”ç”¨æ³¨é‡Šè§£é‡Šå˜é‡ã€‚è¿™ç§æ³¨é‡Šæ˜¯å¤šä½™çš„ã€‚ 

# å‘½åä¸è§„èŒƒ
æ–¹æ³•å‡½æ•°ã€å˜é‡ã€ç±»åã€æ¨¡å—ç­‰éœ€è¦ç®€å•æ˜äº†ï¼Œæµ…æ˜¾æ˜“æ‡‚ï¼Œé¿å…é è‡ªå·±ä¸»è§‚è”æƒ³çå‘½åã€‚ é€šå¸¸é¡¹ç›®ä¸­è¿˜ä¼šå‡ºç°é”™è¯¯çš„å‘½åï¼Œå¸¸è§äºæ‹¼å†™é”™è¯¯ã€‚
```java
// å‘½åä¸è§„èŒƒç¤ºä¾‹
private Integer inputToken;  // è¾“å…¥tokené•¿åº¦
private Integer outputToken; // è¾“å‡ºtokené•¿åº¦
```
ä¸Šé¢è¿™æ®µä»£ç å‘½åä¸è§„èŒƒï¼ŒinputTokençœ‹å‘½ååº”è¯¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡ï¼Œä½†æ˜¯å˜é‡ç±»å‹å´æ˜¯æ•´å‹ï¼Œçœ‹æ³¨é‡Šå‘½ååº”è¯¥æ”¹ä¸º inputTokenLength

```python
# é”™è¯¯çš„å‘½å
from public.pubilc_model.trace_model import ProductVersion
```
ä¸Šé¢çš„è¿™æ®µå¯¼å…¥è¯­å¥publicæ‹¼å†™é”™è¯¯

# æ··ä¹±çš„ä»£ç å±‚æ¬¡è°ƒç”¨
+ controllerå±‚ç›´æ¥è°ƒç”¨daoå±‚ã€‚
+ ä¸‹å±‚æ¨¡å—è°ƒç”¨ä¸Šå±‚ä¸šåŠ¡é€»è¾‘
+ å¼‚å¸¸æ•è·å±‚æ¬¡é”™è¯¯

**ä¸‹å±‚æ¨¡å—è°ƒç”¨ä¸Šå±‚ä¸šåŠ¡é€»è¾‘**  
```python
# user_service.py ï¼ˆé«˜å±‚ä¸šåŠ¡é€»è¾‘ï¼‰
class UserService:
    def create_user(self, user_data):
        # 1. éªŒè¯æ•°æ®
        if not self.validate_user_data(user_data):
            raise ValueError("Invalid data")

        # 2. ä¿å­˜ç”¨æˆ·
        user_id = self.save_user_to_db(user_data)

        # 3. å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆè°ƒç”¨ä½å±‚æ¨¡å—ï¼‰
        EmailService.send_welcome_email(user_id)

        return {"user_id": user_id, "status": "created"}

    def validate_user_data(self, data):
        return data.get("name") and data.get("email")

    def save_user_to_db(self, data):
        # æ¨¡æ‹Ÿæ•°æ®åº“ä¿å­˜
        return 123


# email_service.py ï¼ˆä½å±‚æ¨¡å—ï¼‰
class EmailService:
    @staticmethod
    def send_welcome_email(user_id):
        # é—®é¢˜ï¼šè¿™é‡Œè°ƒç”¨äº†é«˜å±‚çš„ UserServiceï¼
        user_service = UserService()
        user_data = user_service.get_user_by_id(user_id)
        print(f"Sending email to {user_data['email']}")

    def get_user_by_id(self, user_id):
        # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        return {"name": "Alice", "email": "alice@example.com"}
```
> ä½å±‚æ¨¡å— EmailService è°ƒç”¨äº†é«˜å±‚æ¨¡å— UserService çš„æ–¹æ³•
> + EmailService æ˜¯â€œä½å±‚â€ï¼šåªè´Ÿè´£å‘é‚®ä»¶ï¼Œä¸å…³å¿ƒç”¨æˆ·æ˜¯è°ã€ä»å“ªæ¥
> + UserService æ˜¯â€œé«˜å±‚â€ï¼šè´Ÿè´£ç”¨æˆ·åˆ›å»ºã€éªŒè¯ã€ç®¡ç†ç­‰æ ¸å¿ƒä¸šåŠ¡

ğŸ‘‰ æœ¬è¯¥æ˜¯ï¼šé«˜å±‚è°ƒç”¨ä½å±‚ï¼ˆä¸šåŠ¡é€»è¾‘è°ƒç”¨æœåŠ¡ï¼‰
ğŸ‘‰ ä½†è¿™é‡Œå˜æˆäº†ï¼šä½å±‚è°ƒç”¨é«˜å±‚ï¼ˆå‘é‚®ä»¶çš„æ¨¡å—å»æŸ¥ç”¨æˆ·æ•°æ®ï¼‰

**å¼‚å¸¸æ•è·å±‚æ¬¡é”™è¯¯**  
```python
# database.py ï¼ˆåº•å±‚æ¨¡å—ï¼‰
def query_user(user_id):
    try:
        # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        if user_id == 999:
            raise ConnectionError("DB connection failed")
        return {"id": user_id, "name": "Bob"}
    except ConnectionError as e:
        # âŒ é”™è¯¯ï¼šåœ¨åº•å±‚æ¨¡å—æ•è·å¼‚å¸¸å¹¶â€œå¤„ç†â€äº†
        print("Database layer handled the error.")
        return None


# user_service.py ï¼ˆé«˜å±‚ä¸šåŠ¡é€»è¾‘ï¼‰
def get_user_with_fallback(user_id):
    user = query_user(user_id)  # ä»åº•å±‚è°ƒç”¨
    if user is None:
        # é—®é¢˜ï¼šåº•å±‚å·²ç»â€œå¤„ç†â€äº†å¼‚å¸¸ï¼Œé«˜å±‚æ ¹æœ¬ä¸çŸ¥é“å‘ç”Ÿäº†é—®é¢˜ï¼
        return {"error": "User not found (fallback)"}
    return user
```


# è¿åå•ä¸€èŒè´£
ä¸€ä¸ªå‡½æ•°å¹²äº† 8 ä»¶äº‹æƒ…ï¼Œè¿å å•ä¸€èŒè´£åŸåˆ™ï¼Œä¸”è°ƒç”¨é“¾æ¡å¤ªé•¿ï¼Œä¸€æ—¦å‡ºé”™ï¼Œå®šä½å›°éš¾
```python
def handle_transaction(user_id, amount, currency):
    # 1. éªŒè¯ç”¨æˆ·
    if not validate_user(user_id):
        raise Exception("User invalid")

    # 2. æ£€æŸ¥ä½™é¢
    balance = get_balance(user_id)
    if balance < amount:
        raise Exception("Insufficient funds")

    # 3. è®°å½•æ—¥å¿—
    log_transaction(user_id, amount, currency)

    # 4. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
    payment_result = call_payment_gateway(user_id, amount, currency)

    # 5. æ›´æ–°ç”¨æˆ·ä½™é¢
    update_balance(user_id, balance - amount)

    # 6. å‘é€é€šçŸ¥
    send_notification(user_id, f"æ”¯ä»˜æˆåŠŸï¼š{amount}{currency}")

    # 7. è§¦å‘é£æ§æ£€æŸ¥
    if should_trigger_risk_check(user_id):
        trigger_risk_alert(user_id, amount)

    # 8. æœ€åè¿”å›ç»“æœ
    return {"status": "success", "tx_id": generate_tx_id()}
```

# è¿‡åº¦åµŒå¥—çš„å‡½æ•°è°ƒç”¨
äº”å±‚åµŒå¥— ifï¼Œé€»è¾‘åƒâ€œæ´‹è‘±â€ä¸€æ ·å±‚å±‚å‰¥å¼€ï¼Œå‡½æ•°åæ¨¡ç³Šï¼Œâ€œsend_welcome_emailâ€æ˜¯å¦æˆåŠŸï¼Ÿä¸çŸ¥é“ï¼Œä¸€æ—¦å‡ºé”™ï¼Œå¾ˆéš¾åˆ¤æ–­æ˜¯å“ªä¸ªç¯èŠ‚å¤±è´¥äº†ã€‚
```python
def process_user_data(user_id):
    if validate_user(user_id):
        if get_user_profile(user_id):
            if send_welcome_email(user_id):
                if log_action(user_id, "welcome_sent"):
                    return "Success"
                else:
                    return "Log failed"
            else:
                return "Email failed"
        else:
            return "Profile not found"
    else:
        return "Invalid user"
```
> ä¼˜åŒ–å»ºè®®ï¼šæŠŠæ¯ä¸€æ­¥æ‹†æˆç‹¬ç«‹å‡½æ•°ï¼ŒåŠ å¼‚å¸¸å¤„ç†ï¼Œæå‰è¿”å›å¤±è´¥


